# Rails Migrations Best Practices

## The `change` Method vs `up`/`down`

The `change` method is the preferred way to write migrations. Active Record can automatically reverse most common schema operations defined within it.

### Supported `change` Operations
- `create_table`
- `add_column`
- `remove_column` (Must supply type/options for reversibility)
- `rename_column`
- `add_index` / `remove_index`
- `add_reference`
- `create_join_table`

### When to use `up` and `down`
If you need to perform an operation that Active Record doesn't know how to reverse automatically (e.g., changing data, complicated SQL views, or modifying constraints in a specific way), you must define `up` and `down` methods explicitly.

```ruby
class ChangeProductPrice < ActiveRecord::Migration[8.0]
  def up
    change_column :products, :price, :string
  end

  def down
    change_column :products, :price, :integer
  end
end
```

## Reversible Migrations

For complex migrations inside a `change` method where only *part* of the operation needs specific reversal logic, use `reversible`.

```ruby
class ExampleMigration < ActiveRecord::Migration[8.0]
  def change
    create_table :distributors do |t|
      t.string :zipcode
    end

    reversible do |dir|
      dir.up do
        # Execute SQL or Ruby code when migrating UP
        execute <<-SQL
          CHECK (zipcode ~ '^[0-9]{5}(-[0-9]{4})?$');
        SQL
      end
      dir.down do
        # Execute when migrating DOWN
        # (No action needed if dropping table handles it, but illustrative)
      end
    end
  end
end
```

## Changing Existing Migrations

**Golden Rule:** Never edit a migration file after it has been committed to shared source control or run on production.

- **Development:** If you just created it and haven't pushed, you can edit it and run `bin/rails db:migrate:redo`.
- **Production/Shared:** Create a *new* migration to apply the fix or change. Editing old migrations causes inconsistencies between environments.

## Data Migrations

Avoid changing data in schema migrations if possible.
- **Why?** It slows down deployment, can lock tables, and mixes concerns (schema vs data).
- **Alternative:** Use a temporary maintenance task or a separate data migration framework (like `maintenance_tasks` gem) for heavy data updates.

## Schema File (`db/schema.rb`)

- **Do not edit manually.** This file is auto-generated by Rails.
- **Check it in.** Always version control your `schema.rb`. It is the authoritative source of your database structure for new setups.
- **Conflict Resolution:** If you have merge conflicts in `schema.rb`, checking out the file from the main branch and running `bin/rails db:migrate` locally will usually regenerate it correctly.
